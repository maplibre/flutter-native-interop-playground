# Android
cmake_minimum_required(VERSION 3.25)
project(flmln CXX C)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set(MLN_CORE_INCLUDE_DEPS ON)
set(MLN_WITH_GLFW OFF)
set(MLN_WITH_RTTI ON)
set(MLN_WITH_OPENGL ON)
add_definitions(-DFLMLN_OPENGL -DFLMLN_ANDROID)

include(../../vendor/nunicode.cmake)
include(../../vendor/icu.cmake)

add_subdirectory(../.. ../build-maplibre-native EXCLUDE_FROM_ALL)

add_library(flmln SHARED
  src/flmln.cpp
  src/flmln.h
  src/flmln/flutter_texture_interface.cpp
  src/flmln/flutter_texture_interface.hpp
  src/flmln/map_observer.hpp
  src/flmln/renderer_backend.cpp
  src/flmln/renderer_backend.hpp
  src/flmln/renderer_frontend.hpp
  src/flmln/gl/renderer_backend.hpp
  # src/flmln/platform/darwin/flmln_darwin_stub.c
)

target_link_libraries(flmln PRIVATE mbgl-vendor-icu)
target_link_libraries(flmln PRIVATE mbgl-vendor-unique_resource)
target_link_libraries(flmln PRIVATE mbgl-vendor-boost)
target_link_libraries(flmln PRIVATE mbgl-vendor-sqlite)
target_link_libraries(flmln PRIVATE mbgl-vendor-pmtiles)
target_link_libraries(flmln PRIVATE mbgl-vendor-nunicode)

set_target_properties(flmln PROPERTIES
  PUBLIC_HEADER src/flmln.h
)

target_link_libraries(flmln PRIVATE mbgl-core)

target_include_directories(flmln PRIVATE
  ../../src
)

target_include_directories(flmln PRIVATE
  ../../include
)

target_include_directories(flmln PRIVATE
  ../default/include
)

# file(GLOB_RECURSE DEFAULT_SRCS "../default/src/mbgl/*")

# target_sources(flmln PRIVATE
#     ${DEFAULT_SRCS}
# )

# set_source_files_properties(
#     ../default/src/mbgl/i18n/number_format.cpp
#     PROPERTIES
#     COMPILE_DEFINITIONS
#     MBGL_USE_BUILTIN_ICU
# )

target_sources(
    flmln
    PRIVATE
        ../android/src/async_task.cpp
        ../android/src/attach_env.cpp
        ../android/src/attach_env.hpp
        ../android/src/bitmap.cpp
        ../android/src/bitmap.hpp
        ../android/src/bitmap_factory.cpp
        ../android/src/bitmap_factory.hpp
        ../android/src/image.cpp
        ../android/src/jni.cpp
        ../android/src/jni.hpp
        ../android/src/run_loop.cpp
        ../android/src/run_loop_impl.hpp
        ../android/src/string_util.cpp
        ../android/src/thread.cpp
        ../android/src/timer.cpp
        ../default/src/mbgl/gfx/headless_backend.cpp
        ../default/src/mbgl/gfx/headless_frontend.cpp
        ../default/src/mbgl/map/map_snapshotter.cpp
        ../default/src/mbgl/platform/time.cpp
        ../default/src/mbgl/storage/asset_file_source.cpp
        ../default/src/mbgl/storage/database_file_source.cpp
        ../default/src/mbgl/storage/file_source_manager.cpp
        ../default/src/mbgl/storage/file_source_request.cpp
        ../default/src/mbgl/storage/local_file_request.cpp
        ../default/src/mbgl/storage/local_file_source.cpp
        ../default/src/mbgl/storage/mbtiles_file_source.cpp
        ../default/src/mbgl/storage/main_resource_loader.cpp
        ../default/src/mbgl/storage/offline.cpp
        ../default/src/mbgl/storage/offline_database.cpp
        ../default/src/mbgl/storage/offline_download.cpp
        ../default/src/mbgl/storage/online_file_source.cpp
        ../default/src/mbgl/storage/$<IF:$<BOOL:${MLN_WITH_PMTILES}>,pmtiles_file_source.cpp,pmtiles_file_source_stub.cpp>
        ../default/src/mbgl/storage/sqlite3.cpp
        ../default/src/mbgl/text/bidi.cpp
        ../default/src/mbgl/util/compression.cpp
        ../default/src/mbgl/util/filesystem.cpp
        ../default/src/mbgl/util/monotonic_timer.cpp
        ../default/src/mbgl/util/png_writer.cpp
        ../default/src/mbgl/util/thread_local.cpp
        ../default/src/mbgl/util/utf.cpp
        ../default/src/mbgl/layermanager/layer_manager.cpp
)

target_include_directories(flmln PRIVATE
    ../android/src
  )

target_sources(flmln PRIVATE
    ../android/MapLibreAndroid/src/cpp/i18n/collator.cpp
    ../android/MapLibreAndroid/src/cpp/i18n/number_format.cpp
    ../android/MapLibreAndroid/src/cpp/http_file_source.cpp
    ../android/MapLibreAndroid/src/cpp/logging_android.cpp
    ../android/MapLibreAndroid/src/cpp/logger.cpp
    ../android/MapLibreAndroid/src/cpp/text/local_glyph_rasterizer.cpp
)

if(MLN_WITH_OPENGL)
    target_sources(
        flmln
        PRIVATE
            ../android/src/gl_functions.cpp
    )
endif()

# iOS

# cmake_minimum_required(VERSION 3.25)
# project(flmln CXX C OBJCXX OBJC)

# # Configurations

# set(CMAKE_CXX_STANDARD 20)
# set(CMAKE_CXX_STANDARD_REQUIRED ON)

# set(MLN_CORE_INCLUDE_DEPS ON)
# set(MLN_WITH_GLFW OFF)
# set(MLN_WITH_RTTI ON)

# set(MLN_WITH_METAL ON)

# set(CMAKE_OSX_DEPLOYMENT_TARGET 12.0)
# set(CMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH NO)

# add_definitions(-DFLMLN_MTL -DFLMLN_IOS)

# # maplibre-native

# add_subdirectory(../.. ../build-maplibre-native EXCLUDE_FROM_ALL)

# # flmln

# add_library(flmln SHARED
#   src/flmln.cpp
#   src/flmln.h
#   src/flmln/flutter_texture_interface.cpp
#   src/flmln/flutter_texture_interface.hpp
#   src/flmln/map_observer.hpp
#   src/flmln/renderer_backend.cpp
#   src/flmln/renderer_backend.hpp
#   src/flmln/renderer_frontend.hpp
#   src/flmln/mtl/renderer_backend.hpp
#   # src/flmln/platform/darwin/flmln_darwin_stub.c
# )

# set_target_properties(flmln PROPERTIES
#   PUBLIC_HEADER src/flmln.h
# )

# target_link_libraries(flmln PRIVATE mbgl-vendor-metal-cpp)
# target_link_libraries(flmln PRIVATE mbgl-core)
# target_link_libraries(flmln PRIVATE ios-sdk-static)

# target_include_directories(flmln PRIVATE
#   ../../src
# )

# target_include_directories(flmln PRIVATE
#   ../../include
# )

# target_link_libraries(flmln PRIVATE
#   "-framework Foundation"
#   "-framework CoreFoundation"
#   "-framework CoreGraphics"
#   "-framework ImageIO"
#   "-framework CoreText"
# )

# target_link_options(flmln PRIVATE
#   "-undefined"
#   "dynamic_lookup"
# )

# set_target_properties(mbgl-core PROPERTIES
#   XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC "YES"
# )

# set_target_properties(ios-sdk-static PROPERTIES
#   XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC "YES"
# )

# set(CMAKE_OBJC_FLAGS "-fobjc-arc")
# set(CMAKE_OBJCXX_FLAGS "-fobjc-arc")
# target_compile_options(mbgl-core PRIVATE -fobjc-arc)
# target_compile_options(ios-sdk-static PRIVATE -fobjc-arc)

# set_target_properties(flmln PROPERTIES
#   FRAMEWORK TRUE
#   MACOSX_FRAMEWORK_IDENTIFIER "com.kekland.flmln"
#   XCODE_ATTRIBUTE_PRODUCT_BUNDLE_IDENTIFIER "com.kekland.flmln"
#   XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC "YES"
# )

# # set_target_properties(FRAMEWORK)